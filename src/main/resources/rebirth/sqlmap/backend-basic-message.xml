<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap        
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"        
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
 <sqlMap>
 	
 	<typeAlias alias="category" type="com.model.Category" />
 	<typeAlias alias="picture" type="com.model.Picture" />
	
	<resultMap id="category" class="category">
		<result property="id" column="id"/>
    	<result property="name" column="name"/>
		<result property="parentCategoryId" column="parent_category_id"/>
    </resultMap>
    
    <resultMap id="picture" class="picture">
		<result property="id" column="id"/>
    	<result property="picCollectionName" column="pic_collection_name"/>
		<result property="picCollectionDesc" column="pic_collection_des"/>
		<result property="categoryId" column="category_id"/>
		<result property="createTime" column="create_time"/>
		<result property="defaulePic" column="pic_url"/>
    </resultMap>
    
 	
 	<select id="getCategoryListByParentId" parameterClass="map" resultMap="category">
 		
 		<![CDATA[
 			select id,name,parent_category_id
 			from category
 			where parent_category_id = #parentId#
 			and is_deleted = 0
 			order by id
 		]]>
 		
 	</select>
 	
 	<insert id="addCategory" parameterClass="map">
   		<selectKey resultClass="long" keyProperty="id">
			select LAST_INSERT_ID() as id
        </selectKey>
   		insert into category(name,parent_category_id,create_time,update_time,version,is_deleted)
   		values (#addCategoryName#,#parentId#,now(),now(),1,0)
   </insert>
   
   <update id="deleteCategory" parameterClass="map">
   		update category
   		set is_deleted = 1,
   			update_time = now()
   		where id = #id#
   </update>
   
    <update id="editCategory" parameterClass="map">
   		update category
   		set name=#name#,
   			update_time = now()
   		where id = #id#
   </update>
   
   <insert id="insertNewPic" parameterClass="map">
   		insert into picture_collection(pic_collection_name,pic_collection_des,category_id,create_time,update_time,version,is_deleted)
   		values (#pictureCollectionName#,#pictureCollectionDes#,#categoryId#,now(),now(),1,0)
   		<selectKey resultClass="long" keyProperty="id">
			select LAST_INSERT_ID() as id
        </selectKey>
   </insert>
   
   <insert id="insertPicUrl" parameterClass="map">
   		insert into picture_collection_detail(pic_url,picture_collection_id,create_time,update_time,version,is_deleted)
   		values (#picUrl#,#pictureCollectionId#,now(),now(),1,0)
   </insert>
   
   <select id="getPictureListByCategoryId" parameterClass="map" resultMap="picture">
 		
 		<![CDATA[
 			SELECT pc.id,pc.pic_collection_name,pc.pic_collection_des,pc.category_id,pc.create_time,pcd.pic_url FROM `picture_collection` pc
			left JOIN (
				select * from picture_collection_detail 
				group by picture_collection_detail.picture_collection_id
			)pcd
			on pc.id = pcd.picture_collection_id
			where pc.category_id  = #categoryId#
			and pc.is_deleted = 0
			order by id
 		]]>
 		
 	</select>
 	
 	 <select id="getPictureByPicCollectionId" parameterClass="map" resultMap="picture">
 		<![CDATA[
 			SELECT pc.id,pc.pic_collection_name,pc.pic_collection_des,pc.category_id,pc.create_time,pcd.pic_url FROM `picture_collection` pc
			left JOIN (
				select * from picture_collection_detail 
				group by picture_collection_detail.picture_collection_id
			)pcd
			on pc.id = pcd.picture_collection_id
			where pc.id  = #picCollectionId#
			and pc.is_deleted = 0
 		]]>
 	</select>
 	
 	 <select id="getPictureListByPicCollectionId" parameterClass="map" resultClass="String">
 		<![CDATA[
 			SELECT pcd.pic_url
 			from `picture_collection_detail` pcd
 			where pcd.is_deleted = 0
 			and pcd.picture_collection_id = #picCollectionId#
 		]]>
 	</select>
   
 
 </sqlMap>


